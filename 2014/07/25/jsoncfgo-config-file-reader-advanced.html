<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>jsoncfgo - Advanced Usage</title><meta name=description content="Go Golang Code Examples programming"><meta name=viewport content="width=device-width"><link rel="shortcut icon" href=/golang-code-examples/favicon.ico type=image/x-icon><link rel=icon href=/golang-code-examples/favicon.ico type=image/x-icon><link rel=stylesheet href=/golang-code-examples/styles/main.d9bf.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js></script><!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><meta name=viewport content="width=device-width, initial-scale=1, user-scalable=no"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-53073815-1', 'auto');
        ga('send', 'pageview');</script></head><body><div id=dialogoverlay class=dialogoverlay></div><div id=dialogbox class=dialogbox><div><div id=dialogboxhead class=dialogboxhead></div><div id=dialogboxbody class=dialogboxbody></div><div id=dialogboxfoot class=dialogboxfoot></div></div></div><div class=site><header><h1><a class=home-link href="/golang-code-examples">Golang Code Examples</a></h1></header><div id=banner><span id=logo></span> <a href=https://github.com/l3x/golang-code-examples class="button fork"><strong>View On GitHub</strong></a><div class=downloads><span>Downloads:</span><ul><li><a href=https://github.com/l3x/golang-code-examples/zipball/master class=button>ZIP</a></li><li><a href=https://github.com/l3x/golang-code-examples/tarball/master class=button>TAR</a></li></ul></div></div><!-- end banner --><div class=wrapper><nav><ul></ul></nav><div class=page-title><h2>jsoncfgo - Advanced Usage</h2><p class=meta>25 Jul 2014</p></div><div class=post><section><h2>Description</h2><p>This example demonstrates some advanced usages of the jsoncfgo config file reader to read non-trivial json-based configuration files.</p><p><br></p><h3>jsoncfgo Features</h3><p>jsoncfgo can handle the following data types in the .json configuration file that it reads:</p><ul><li>bool</li><li>int</li><li>int64</li><li>string</li><li>[]string</li><li>[]int64</li></ul><p><br></p><h3>jsconfgo Advanced Features</h3><ul><li>Read <strong>environment variables</strong></li><li>Handle <strong>included file</strong> objects that refer to other config files</li><li>Handle <strong>nested json objects</strong> within the config file</li><li><strong>Validation</strong>:<ul><li>Validate existence of <strong>required</strong> variables</li><li>Validate attempt to read <strong>non-existent</strong> variable</li></ul></li></ul><hr><h2>Golang Features</h2><p>This golang code sample demonstrates the following go language features:</p><ul><li>basic error handling</li><li>error logging</li><li>string package</li><li>helper functions: padLeft, padRight</li><li>formatted printing</li><li>assigning default value to optional parameter</li><li>reflection for inspecting data types</li><li>wait/sleep</li></ul><hr><h2>Code Example</h2><p>In this code example we demonstrate how to use simple jsoncfgo functions to read a json-based configuration file. ``` go package main</p><p>import ( &quot;fmt&quot; &quot;log&quot; &quot;reflect&quot; &quot;strings&quot; &quot;time&quot; &quot;github.com/l3x/jsoncfgo&quot; )</p><p>// Environment holds the values corresponding to JSON config file type Environment struct { Database string Host string Port int Adapter string Encoding string Active bool Pool int SchemaList []string ImagePaths map[string]interface{} }</p><p>// ---------------------- // Helper functions // ---------------------- func padRight(s string, padLen int, args ...interface{}) string{ padStr := &quot; &quot; for _, arg := range args { switch t := arg.(type) { case string: padStr = t default: panic(&quot;Unknown argument&quot;) } } return s + strings.Repeat(padStr, padLen); }</p><p>func padLeft(s string, padLen int, args ...interface{}) string{ padStr := &quot; &quot; for _, arg := range args { switch t := arg.(type) { case string: padStr = t default: panic(&quot;Unknown argument&quot;) } } return strings.Repeat(padStr, padLen) + s; }</p><p>func printEnvironment(envMap *Environment) { t := envMap s := reflect.ValueOf(t).Elem() fldName := &quot;&quot; fldType := s.Type() thisType := &quot;&quot; thisVal := &quot;&quot; for i := 0; i &lt; s.NumField(); i++ { f := s.Field(i) fldName = fldType.Field(i).Name thisType = fmt.Sprintf(&quot;%v&quot;, fldType.Field(i).Type) thisVal = fmt.Sprintf(&quot;%v&quot;, f.Interface()) fmt.Printf(&quot;%s (%s) %v %v\n&quot;, padRight(fldName, 10 - len(fldName)), thisType, padLeft(&quot;&quot;, 25 - len(thisType), &quot;.&quot;), thisVal) } }</p><p>func main() {</p><div class=highlight><pre><code class="text language-text" data-lang=text>configPath := &quot;/Users/lex/dev/go/samples/src/bitbucket.org/l3x/config/testdata/client-config2.json&quot;
cfg, err := jsoncfgo.ReadFile(configPath)
if err != nil {
    log.Fatal(err.Error())  // Handle error here
}

identity := cfg.RequiredString(&quot;identity&quot;)
fmt.Printf(&quot;identity: %v\n\n&quot;, identity)

path := cfg.RequiredString(&quot;path&quot;)
fmt.Printf(&quot;path: %v\n\n&quot;, path)

badkey := cfg.OptionalString(&quot;badkey&quot;, &quot;INVALID&quot;)
fmt.Printf(&quot;badkey: %v\n&quot;, badkey)

badkey = cfg.RequiredString(&quot;badkey&quot;)
fmt.Printf(&quot;badkey: %v\n\n&quot;, badkey)

environmentsList := make(map[string]*Environment)
environments := cfg.OptionalObject(&quot;environments&quot;)

for alias, envMap := range environments {

    environmentMap, ok := envMap.(map[string]interface{})
    if !ok {
        log.Fatalf(&quot;entry %q in environments section is a %T, want an object&quot;, alias, envMap)
    }
    environmentConf := jsoncfgo.Obj(environmentMap)
    environment := &amp;Environment{
        Database:   environmentConf.OptionalString(&quot;database&quot;, &quot;&quot;),
        Host:       environmentConf.OptionalString(&quot;host&quot;, &quot;&quot;),
        Port:       environmentConf.OptionalInt(&quot;port&quot;, 5432),
        Adapter:    environmentConf.OptionalString(&quot;adapter&quot;, &quot;&quot;),
        Encoding:   environmentConf.OptionalString(&quot;encoding&quot;, &quot;unicode&quot;),
        Active:     environmentConf.OptionalBool(&quot;active&quot;, true),
        Pool:       environmentConf.OptionalInt(&quot;pool&quot;, 5),
        SchemaList: environmentConf.OptionalList(&quot;schema_list&quot;),
        ImagePaths: environmentConf.OptionalObject(&quot;image_paths&quot;),
    }
    if err := environmentConf.Validate(); err != nil {
        log.Fatalf(&quot;Error in environments section of config file for environment %q: %v&quot;, alias, err)
    }
    environmentsList[alias] = environment

    productionEnvMap := cfg.RequiredObject(&quot;misc&quot;)
    included_val1 := productionEnvMap.RequiredString(&quot;key&quot;)
    included_val2 := productionEnvMap.RequiredString(&quot;key&quot;)
    fmt.Println(&quot;included_val1&quot;, included_val1)
    fmt.Println(&quot;included_val2\n&quot;, included_val2)

    for alias, envMap := range environmentsList {
        fmt.Printf(&quot;alias: %v\n&quot;, alias)
        fmt.Printf(&quot;envMap: %v\n\n&quot;, envMap)
        printEnvironment(envMap)
        fmt.Println();
    }
}
if err := cfg.Validate(); err != nil {
    time.Sleep(100 * time.Millisecond)
    defer log.Fatalf(&quot;ERROR - Invalid config file...\n%v&quot;, err)
    return
}
</code></pre></div><p>} ```<hr></p><h2>Notes</h2><p>We load a section of the configuration file into the <strong>Environment</strong> struct that we defined.</p><p>We leverage the strings package to create two helper functions, padLeft and padRight.</p><p>We create a helper function, printEnvironment, that takes a pointer to the <strong>Environment</strong> struct.</p><p>You will need to change the <strong>configPath</strong> to point to a the configuration file on your computer.</p><p>We handle any read errors immediately after attempting to read the configuration file.</p><p>We sleep for a second to prevent the log.Fatal statement in order to ensure that the error messages are printed at the end of our output log.</p><p><br></p><hr><h2>Input Files</h2><h3>example.json</h3><div class=highlight><pre><code class="json language-json" data-lang=json><span class=p>{</span>
    <span class=nt>&quot;environments&quot;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&quot;development&quot;</span><span class=p>:</span> <span class=p>{</span>
           <span class=nt>&quot;database&quot;</span><span class=p>:</span> <span class=s2>&quot;example_development&quot;</span><span class=p>,</span>
           <span class=nt>&quot;host&quot;</span><span class=p>:</span> <span class=s2>&quot;localhost&quot;</span><span class=p>,</span>
           <span class=nt>&quot;port&quot;</span><span class=p>:</span> <span class=mi>5432</span><span class=p>,</span>
            <span class=nt>&quot;adapter&quot;</span><span class=p>:</span> <span class=s2>&quot;postgresql&quot;</span><span class=p>,</span>
            <span class=nt>&quot;encoding&quot;</span><span class=p>:</span> <span class=s2>&quot;unicode&quot;</span><span class=p>,</span>
            <span class=nt>&quot;active&quot;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
            <span class=nt>&quot;pool&quot;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
            <span class=nt>&quot;schema_list&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;myapp&quot;</span><span class=p>,</span> <span class=s2>&quot;sharedapp&quot;</span><span class=p>],</span>
            <span class=nt>&quot;image_paths&quot;</span><span class=p>:</span> <span class=p>{</span>
                     <span class=nt>&quot;image_profile_path&quot;</span><span class=p>:</span> <span class=s2>&quot;/var/www/photos/profile&quot;</span><span class=p>,</span>
                     <span class=nt>&quot;default_image_path&quot;</span><span class=p>:</span> <span class=s2>&quot;/var/www/photos/default&quot;</span>
                   <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>},</span>
    <span class=nt>&quot;ignoredFiles&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;.DS_Store&quot;</span><span class=p>,</span> <span class=s2>&quot;*.o&quot;</span><span class=p>,</span> <span class=s2>&quot;*.a&quot;</span><span class=p>,</span> <span class=s2>&quot;*.so&quot;</span><span class=p>],</span>
    <span class=nt>&quot;identity&quot;</span><span class=p>:</span> <span class=s2>&quot;26F5ABDA&quot;</span><span class=p>,</span>
    <span class=nt>&quot;path&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;_env&quot;</span><span class=p>,</span> <span class=s2>&quot;${PATH}&quot;</span><span class=p>],</span>
    <span class=nt>&quot;misc&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;_fileobj&quot;</span><span class=p>,</span> <span class=s2>&quot;/Users/lex/dev/go/samples/src/bitbucket.org/l3x/config/testdata/example-include.json&quot;</span><span class=p>],</span>
    <span class=nt>&quot;bogusKey&quot;</span><span class=p>:</span> <span class=s2>&quot;bogus data&quot;</span>
<span class=p>}</span>
</code></pre></div><p><br></p><h3>example_include.json</h3><div class=highlight><pre><code class="json language-json" data-lang=json><span class=p>{</span>
  <span class=nt>&quot;key1&quot;</span><span class=p>:</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span>
  <span class=nt>&quot;key2&quot;</span><span class=p>:</span> <span class=s2>&quot;value2&quot;</span>
<span class=p>}</span>
</code></pre></div><hr><h2>Output</h2><pre><code>
identity: 26F5ABDA

path: /usr/bin:/bin:/usr/sbin:/sbin:/usr/local/Cellar/go/1.2.2/libexec/bin:$GOPATH/bin:/Users/lex/dev/go/samples/bin

badkey: INVALID
badkey: 

included_val1 
included_val2
 
alias: development
envMap: &{example_development localhost 5432 postgresql unicode true 5 [myapp sharedapp] map[image_profile_path:/var/www/photos/profile default_image_path:/var/www/photos/default]}

Database   (string) ................... example_development
Host       (string) ................... localhost
Port       (int) ...................... 5432
Adapter    (string) ................... postgresql
Encoding   (string) ................... unicode
Active     (bool) ..................... true
Pool       (int) ...................... 5
SchemaList ([]string) ................. [myapp sharedapp]
ImagePaths (map[string]interface {}) .. map[image_profile_path:/var/www/photos/profile default_image_path:/var/www/photos/default]
<span style=color:red>
2014/07/24 16:10:06 ERROR - Invalid config file...
Multiple errors: Missing required config key "badkey" (string), Unknown key "bogusKey", Unknown key "ignoredFiles"
exit status 1
</span>
Process finished with exit code 1
</code></pre><hr><h2>References</h2><ul><li><a href="http://golang.org/pkg/log/">Package log</a></li><li><a href="http://golang.org/pkg/reflect/">Package reflect</a></li><li><a href="http://golang.org/pkg/time/">Package time</a></li><li><a href=http://blog.golang.org/error-handling-and-go>Error handling and Go</a></li><li><a href="http://golang.org/pkg/strings/#Repeat/">String Package&#39;s Repeat Function</a></li><li><a href=http://blog.golang.org/go-maps-in-action>Maps in Action</a></li><li><a href=https://gobyexample.com/pointers>Go by Example: Pointers</a></li><li><a href="http://tour.golang.org/">Golang Tour</a></li></ul></section></div></div><div class=footer><div class=contact><div id=name-gravatar class=float-left><span>By Lex Sheehan</span> <span class=l3x-gravatar></span></div><div class=float-right><strong>It's Go Time!</strong></div></div></div><div class=license-notice>This work is licensed under the <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 Unported License</a>.</div></div><script src=/golang-code-examples/scripts/scripts.db44.js></script></body></html>
